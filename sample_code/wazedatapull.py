import urllib.request
import os
import time
import datetime
import boto
from boto.s3.key import Key

wazeURL = os.environ['wazeURL']

class StatePolygon:
   def __init__(self, state, polygon):
     self.state = state
     self.polygon = polygon

StatePolygons = [\
StatePolygon("AL", "-88.8134765625,35.31019457613117;-84.7265625,35.31019457613117;-84.7265625,29.909234137188207;-88.8134765625,29.909234137188207;-88.8134765625,35.31019457613117"),\
StatePolygon("AK", "-170.859375,71.65813222874152;-139.306640625,71.65813222874152;-139.306640625,53.21524392300821;-170.859375,53.21524392300821;-170.859375,71.65813222874152"),\
StatePolygon("AZ", "-115.4443359375,37.5724468842953;-108.4130859375,37.5724468842953;-108.4130859375,30.781486256858663;-115.4443359375,30.781486256858663;-115.4443359375,37.5724468842953"),\
StatePolygon("AR", "-95.0537109375,37.25831504796368;-89.5166015625,37.25831504796368;-89.5166015625,32.613467348649095;-95.0537109375,32.613467348649095;-95.0537109375,37.25831504796368"),\
StatePolygon("CA1", "-125.15625,42.35204906446211;-117.509765625,42.35204906446211;-117.509765625,36.44956669440303;-125.15625,36.44956669440303;-125.15625,42.35204906446211"),\
#StatePolygon("CA", "-122.16796875,36.76705222086377;-113.7744140625,36.76705222086377;-113.7744140625,32.24254110831028;-122.16796875,32.24254110831028;-122.16796875,36.76705222086377"),\
StatePolygon("CA2", "-118.63037109375,33.90689555128866;-114.4775390625,33.90689555128866;-114.49951171875,32.54681317351514;-117.04833984375,32.41706632846282;-118.63037109375,33.90689555128866"),\
StatePolygon("CA3", "-122.16796875,36.76705222086377;-116.89453125,36.78465196163907;-114.9169921875,35.283294428435106;-113.90625,34.063581743090474;-118.4326171875,33.97252033295277;-120.6298828125,34.51742011432834;-122.16796875,36.76705222086377"),\
StatePolygon("CO", "-109.2919921875,41.30422183593844;-101.6455078125,41.30422183593844;-101.6455078125,36.80224766126684;-109.2919921875,36.80224766126684;-109.2919921875,41.30422183593844"),\
StatePolygon("CT", "-73.7841796875,42.12919178045108;-71.729736328125,42.12919178045108;-71.729736328125,40.903549021734854;-73.7841796875,40.903549021734854;-73.7841796875,42.12919178045108"),\
StatePolygon("DE", "-75.926513671875,39.79840784076671;-74.72900390625,39.79840784076671;-74.72900390625,38.32269665125801;-75.926513671875,38.32269665125801;-75.926513671875,39.79840784076671"),\
StatePolygon("DC", "-77.222900390625,39.01448892512278;-76.87957763671875,39.01448892512278;-76.87957763671875,38.798620776253976;-77.222900390625,38.798620776253976;-77.222900390625,39.01448892512278"),\
StatePolygon("FL", "-87.8466796875,31.30859259016578;-78.6181640625,31.30859259016578;-78.6181640625,24.678966506765818;-87.8466796875,24.678966506765818;-87.8466796875,31.30859259016578"),\
StatePolygon("GA", "-86.0888671875,35.41770571151509;-80.1123046875,35.41770571151509;-80.1123046875,30.137526610743695;-86.0888671875,30.137526610743695;-86.0888671875,35.41770571151509"),\
StatePolygon("HI", "-161.71875,23.53175895188678;-152.75390625,23.53175895188678;-152.75390625,17.2751211133557;-161.71875,17.2751211133557;-161.71875,23.53175895188678"),\
StatePolygon("ID", "-117.04833984375,49.023461463214126;-116.91650390625,46.01222384063236;-116.52099609375,45.72152152227953;-117.26806640625,44.386691502152054;-116.87255859375,44.08758502824516;-117.04833984375,43.834526782236814;-117.0263671875,42.00032514831621;-111.005859375,42.00032514831621;-111.0498046875,44.465151013519616;-112.9833984375,44.49650533109348;-113.9501953125,45.644768217751924;-114.4775390625,46.70973594407157;-115.8837890625,47.694974341862824;-117.04833984375,49.023461463214126"),\
StatePolygon("IL", "-91.56005859375,42.90494128045263;-86.94580078125,42.90494128045263;-86.94580078125,36.80576626250115;-91.56005859375,36.80576626250115;-91.56005859375,42.90494128045263"),\
StatePolygon("IN", "-88.26416015625,41.964391737323325;-84.74853515625,41.964391737323325;-84.74853515625,37.488807194630354;-88.26416015625,37.488807194630354;-88.26416015625,41.964391737323325"),\
StatePolygon("IA", "-97.119140625,43.87888982956621;-89.97802734375,43.87888982956621;-89.97802734375,40.175515711323214;-97.119140625,40.175515711323214;-97.119140625,43.87888982956621"),\
StatePolygon("KS", "-102.3486328125,40.12513096205696;-94.41650390625,40.12513096205696;-94.41650390625,36.80576626250115;-102.3486328125,36.80576626250115;-102.3486328125,40.12513096205696"),\
StatePolygon("KY", "-89.6923828125,39.296898504991724;-81.7822265625,39.296898504991724;-81.7822265625,36.25844877609728;-89.6923828125,36.25844877609728;-89.6923828125,39.296898504991724"),\
StatePolygon("LA", "-94.3505859375,33.207439731303076;-88.6376953125,33.207439731303076;-88.6376953125,28.64817420658171;-94.3505859375,28.64817420658171;-94.3505859375,33.207439731303076"),\
StatePolygon("ME", "-71.19140625,47.6180133217535;-66.81884765625,47.6180133217535;-66.81884765625,42.40398983626658;-71.19140625,42.40398983626658;-71.19140625,47.6180133217535"),\
StatePolygon("MD", "-79.6728515625,39.8895081873108;-74.33349609375,39.8895081873108;-74.33349609375,37.10426039536578;-79.6728515625,37.10426039536578;-79.6728515625,39.8895081873108"),\
StatePolygon("MA", "-73.63037109375,42.93712212295098;-69.4775390625,42.93712212295098;-69.4775390625,41.059472602319495;-73.63037109375,41.059472602319495;-73.63037109375,42.93712212295098"),\
StatePolygon("MI", "-82.7490234375,41.56778551532283;-81.03515625,44.08127132392068;-85.60546875,48.65613697696939;-89.82421875,48.423367926325206;-90.52734375,46.09761410512681;-86.30859375,45.175841092771286;-87.16552734375,43.398661383389374;-86.7041015625,41.501994814397804;-82.7490234375,41.56778551532283"),\
StatePolygon("MN", "-97.55859375,49.37665079314985;-91.0107421875,49.37665079314985;-91.0107421875,43.12664694836631;-97.55859375,43.12664694836631;-97.55859375,49.37665079314985"),\
StatePolygon("MS", "-91.93359375,35.23844098454394;-87.8466796875,35.23844098454394;-87.8466796875,28.952398466218092;-91.93359375,28.952398466218092;-91.93359375,35.23844098454394"),\
StatePolygon("MO", "-96.2841796875,40.940074883260756;-88.857421875,40.940074883260756;-88.857421875,35.81068605571945;-96.2841796875,35.81068605571945;-96.2841796875,40.940074883260756"),\
StatePolygon("MT", "-117.333984375,49.433841190381315;-117.2900390625,45.361408848273655;-112.1044921875,43.92321938762208;-102.919921875,44.8963519152724;-103.095703125,49.57652692164745;-117.333984375,49.433841190381315"),\
StatePolygon("NE", "-104.326171875,43.31878365022329;-95.09765625,43.31878365022329;-95.09765625,39.66660525438953;-104.326171875,39.66660525438953;-104.326171875,43.31878365022329"),\
StatePolygon("NV", "-120.4541015625,42.38451661720977;-120.322265625,38.54129088479037;-114.4775390625,34.58980590477723;-113.203125,37.118277858264626;-113.203125,42.61132294645021;-120.4541015625,42.38451661720977"),\
StatePolygon("NH", "-72.454833984375,42.73087427928485;-71.092529296875,42.68243539838623;-71.048583984375,45.29034662473613;-71.4990234375,45.042478050891546;-71.597900390625,44.44946753600694;-72.015380859375,44.33170718680922;-72.39990234375,43.54058479482877;-72.454833984375,42.73087427928485"),\
StatePolygon("NJ", "-73.773193359375,40.94505441205937;-74.849853515625,41.490475365746775;-75.355224609375,40.495421873526254;-74.8388671875,40.042755867334854;-75.728759765625,39.6124597933049;-75.047607421875,38.683794997910766;-73.49853515625,40.33649600250291;-74.190673828125,40.520481110532124;-73.773193359375,40.94505441205937"),\
StatePolygon("NM", "-109.16015625,37.1918299629268;-102.83203125,37.1918299629268;-102.83203125,31.199646143917523;-109.16015625,31.199646143917523;-109.16015625,37.1918299629268"),\
StatePolygon("NY", "-79.82666015625,41.91535963380693;-79.69482421875,42.64689032054753;-74.970703125,45.209908398312926;-73.36669921875,45.209908398312926;-73.0810546875,42.792176717837364;-73.63037109375,41.04290327207866;-71.71875,41.22494465533274;-71.91650390625,40.54386169095133;-74.8828125,40.52716240005039;-75.322265625,41.75164456330194;-79.82666015625,41.91535963380693"),\
StatePolygon("NC", "-84.04541015625,36.735362452378475;-75.21240234375,36.735362452378475;-75.21240234375,33.70240684272235;-84.04541015625,33.70240684272235;-84.04541015625,36.735362452378475"),\
StatePolygon("ND", "-104.4140625,49.405254536782714;-96.3720703125,49.405254536782714;-96.3720703125,45.669340825615706;-104.4140625,45.669340825615706;-104.4140625,49.405254536782714"),\
StatePolygon("OH", "-85.078125,42.09170072053559;-80.419921875,42.09170072053559;-80.419921875,38.30028357339786;-85.078125,38.30028357339786;-85.078125,42.09170072053559"),\
StatePolygon("OK", "-103.18359375,37.363173625090944;-94.39453125,37.22333183404916;-93.9111328125,33.27727419538735;-100.4150390625,33.82662074582517;-100.458984375,36.23718618278811;-103.7109375,36.13077808157701;-103.18359375,37.363173625090944"),\
StatePolygon("OR", "-124.8046875,46.64340257601005;-116.0595703125,46.64340257601005;-116.0595703125,41.37021320682127;-124.8046875,41.37021320682127;-124.8046875,46.64340257601005"),\
StatePolygon("PA", "-80.7275390625,42.4850613507255;-74.72900390625,42.4850613507255;-74.72900390625,39.5684347845591;-80.7275390625,39.5684347845591;-80.7275390625,42.4850613507255"),\
StatePolygon("RI", "-71.82861328125,42.05581881264781;-70.86181640625,42.05581881264781;-70.86181640625,41.21833303881092;-71.82861328125,41.21833303881092;-71.82861328125,42.05581881264781"),\
StatePolygon("SC", "-83.38623046875,35.25997450236492;-80.771484375,35.42128771466762;-77.34375,33.77549546850551;-80.74951171875,31.630934841424313;-83.78173828125,34.86430017292065;-83.38623046875,35.25997450236492"),\
StatePolygon("SD", "-104.4140625,46.15852704679452;-95.8447265625,46.15852704679452;-95.8447265625,42.384517112504824;-104.4140625,42.384517112504824;-104.4140625,46.15852704679452"),\
StatePolygon("TN", "-90.76904296875,34.774107064886074;-83.9794921875,34.79215358545639;-80.68359375,36.75297027127622;-90.087890625,36.82335791695187;-90.76904296875,34.774107064886074"),\
StatePolygon("TX", "-107.9736328125,32.01925643360525;-98.4375,24.591090256317678;-91.93359375,29.74912082117641;-93.779296875,34.21998208531425;-100.634765625,37.00606552913003;-103.623046875,36.583778876483514;-107.9736328125,32.01925643360525"),\
StatePolygon("UT", "-114.169921875,42.54013019753373;-108.6328125,42.54013019753373;-108.6328125,36.81280324835696;-114.169921875,36.81280324835696;-114.169921875,42.54013019753373"),\
StatePolygon("VT", "-71.531982421875,45.02695045318545;-73.355712890625,45.01918507438175;-73.27880859375,42.75507954507213;-72.432861328125,42.72280375732727;-72.454833984375,43.28520334369384;-72.103271484375,44.01652134387754;-71.510009765625,44.5982904898401;-71.531982421875,45.02695045318545"),
StatePolygon("VA", "-84.00146484375,36.453102242570374;-75.08056640625,36.41774706445821;-74.99267578125,38.68208019471739;-78.5302734375,39.8895089590654;-84.00146484375,36.453102242570374"),\
StatePolygon("WA", "-125.7275390625,49.60501457718161;-116.015625,49.60501457718161;-116.015625,45.4231304235298;-125.7275390625,45.4231304235298;-125.7275390625,49.60501457718161"),\
StatePolygon("WV", "-80.52978515625,40.97658119004617;-83.232421875,38.16565996008127;-80.771484375,36.61200111558852;-77.34375,39.85578219375357;-80.52978515625,40.97658119004617"),\
StatePolygon("WI", "-89.8681640625,47.52907179715088;-93.40576171875,46.75190648688809;-92.8125,44.19480912928294;-90.6591796875,42.192713790689666;-86.6162109375,42.339057840416174;-85.78125,45.534059212255066;-89.8681640625,47.52907179715088"),\
StatePolygon("WY", "-111.3134765625,45.20681165487806;-103.53515625,45.20681165487806;-103.53515625,40.70729370080512;-111.3134765625,40.70729370080512;-111.3134765625,45.20681165487806")]

s3 = boto.connect_s3(aws_access_key_id=os.environ['s3WazeAccessKey'], aws_secret_access_key=os.environ['s3WazeSecretKey'])
bucket = s3.get_bucket(os.environ['s3WazeBucketName'])

for sp in StatePolygons:
  data = urllib.request.urlopen(wazeURL + sp.polygon)
  ts = time.time()
  st = datetime.datetime.fromtimestamp(ts).strftime('_%Y-%m-%d_%H-%M-%S')
  dt = datetime.datetime.fromtimestamp(ts).strftime('%Y-%m-%d')
  item = Key(bucket)
  item.key = sp.state + '/' + dt + '/' + sp.state + st + '.json'
  item.set_contents_from_string(data.read().decode('utf-8'))

print("Done")